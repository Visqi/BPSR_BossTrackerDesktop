<!DOCTYPE html>
<html>
<head>
    <title>SSE Test</title>
</head>
<body>
    <h1>PocketBase SSE Connection Test</h1>
    <div id="log"></div>
    
    <script>
        const log = document.getElementById('log');
        
        function addLog(message, data = null) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (data) {
                entry.textContent += ': ' + JSON.stringify(data);
            }
            log.appendChild(entry);
            console.log(message, data);
        }
        
        addLog('Starting SSE connection test...');
        
        const eventSource = new EventSource('https://db.bptimer.com/api/realtime');
        
        eventSource.onopen = () => {
            addLog('âœ“ SSE Connection opened');
        };
        
        eventSource.onerror = (error) => {
            addLog('âŒ SSE error', error);
        };
        
        eventSource.addEventListener('PB_CONNECT', (event) => {
            const data = JSON.parse(event.data);
            addLog('âœ“ PB_CONNECT received', data);
            
            // Subscribe to collections
            fetch('https://db.bptimer.com/api/realtime', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    clientId: data.clientId,
                    subscriptions: ['mobs/*', 'mob_channel_status_sse/*', 'mob_reset_events/*']
                })
            })
            .then(res => {
                addLog('âœ“ Subscription POST status: ' + res.status);
                return res.text();
            })
            .then(text => {
                addLog('âœ“ Subscription response', text);
            });
        });
        
        // Listen for collection-specific events
        ['mobs', 'mob_channel_status_sse', 'mob_reset_events'].forEach(collection => {
            eventSource.addEventListener(collection, (event) => {
                addLog(`ğŸ“¨ Event from ${collection}`, JSON.parse(event.data));
            });
        });
        
        // Listen for all messages
        eventSource.onmessage = (event) => {
            addLog('ğŸ“¨ Generic message event', JSON.parse(event.data));
        };
    </script>
</body>
</html>
